global:
  env: production
  release:
    enabled: true
    current: "production-v1"
    autoEnableApps: true
    versions:
      production-v1:
        release-web: "3.19"
  _includes:
    base-a:
      data:
        fromBaseA: "A"
    base-b:
      data:
        fromBaseB: "B"
    profile-base:
      enabled: true
      _include: ["base-a"]
      envVars:
        A: "1"
        ENV_SWITCH:
          _default: "base-default"
          production: "base-production"
      data:
        key1: "value-1"
        key2: "base-value-2"
    profile-override:
      _include: ["base-b"]
      envVars:
        A: "2"
        ENV_SWITCH:
          _default: "override-default"
      data:
        key2: "override-value-2"
        key4: "value-4"

jwtSigningMethod: rsa
_include_files:
  - deployments-values.yaml

apps-configmaps:
  merge-contract:
    _include: ["profile-base", "profile-override"]
    enabled: true
    envVars:
      LOCAL: "ok"
    data:
      key2: "local-value-2"
      key3: "value-3"
  compat-config:
    enabled: true
    extraFields: |
      immutable: true
    data:
      key: value

apps-stateless:
  release-auto-app:
    enabled: false
    releaseKey: release-web
    containers:
      main:
        image:
          name: alpine
        command: |
          - sh
        args: |
          - -c
          - sleep 3600
  compat-service:
    enabled: true
    extraSpec: |
      paused: true
    podSpecExtra: |
      os:
        name: linux
    containers:
      main:
        image:
          name: alpine
          staticTag: "3"
        command: |
          - sh
        args: |
          - -c
          - sleep 3600
        ports: |
          - name: http
            containerPort: 8080
        extraFields: |
          resizePolicy:
            - resourceName: cpu
              restartPolicy: NotRequired
    service:
      enabled: true
      type: LoadBalancer
      allocateLoadBalancerNodePorts: true
      loadBalancerClass: internal-vip
      internalTrafficPolicy: Local
      ipFamilyPolicy: SingleStack
      ipFamilies: |
        - IPv4
      ports: |
        - name: http
          port: 80
          targetPort: 8080
      extraSpec: |
        externalTrafficPolicy: Local

apps-jobs:
  compat-job:
    enabled: true
    containers:
      main:
        image:
          name: alpine
          staticTag: "3"
        command: |
          - sh
        args: |
          - -c
          - echo test
    jobTemplateExtraSpec: |
      podFailurePolicy:
        rules: []

apps-ingresses:
  compat-ingress:
    enabled: true
    host: app.example.com
    paths: |
      - path: /
        pathType: Prefix
        backend:
          service:
            name: compat-service
            port:
              number: 80
    extraSpec: |
      defaultBackend:
        service:
          name: compat-service
          port:
            number: 80

apps-network-policies:
  compat-netpol:
    enabled: true
    type: kubernetes
    podSelector: |
      matchLabels:
        app: compat-service
    policyTypes: |
      - Ingress
      - Egress
    ingress: |
      - from:
          - namespaceSelector:
              matchLabels:
                kubernetes.io/metadata.name: ingress-nginx
    egress: |
      - to:
          - namespaceSelector:
              matchLabels:
                kubernetes.io/metadata.name: kube-system
        ports:
          - protocol: UDP
            port: 53
  compat-cilium-netpol:
    enabled: true
    type: cilium
    spec: |
      endpointSelector:
        matchLabels:
          app: compat-service
      egress:
        - toEndpoints:
            - matchLabels:
                k8s:io.kubernetes.pod.namespace: kube-system
  compat-calico-netpol:
    enabled: true
    type: calico
    selector: "app == 'compat-service'"
    ingress: |
      - action: Allow
        source:
          selector: "kubernetes.io/metadata.name == 'ingress-nginx'"
    egress: |
      - action: Allow
        destination:
          selector: "kubernetes.io/metadata.name == 'kube-system'"

apps-pvcs:
  compat-pvc:
    enabled: true
    accessModes: |
      - ReadWriteOnce
    resources: |
      requests:
        storage: 1Gi
    extraSpec: |
      volumeMode: Filesystem

apps-secrets:
  compat-secret:
    enabled: true
    extraFields: |
      stringData:
        token: value

custom-group-contract:
  __GroupVars__:
    type: apps-configmaps
  custom-group-cm:
    enabled: true
    data:
      custom: "ok"

apps-routes-contract:
  __GroupVars__:
    type:
      _default: apps-ingresses
    paths: |
      - path: /
        pathType: Prefix
        backend:
          service:
            name: compat-service
            port:
              number: 80
    _groupPreRenderHook: |
      {{- if not (hasKey $.CurrentApp "paths") }}
      {{- $_ := set $.CurrentApp "paths" $.CurrentGroupVars.paths }}
      {{- end }}
  compat-route:
    enabled: true
    host: route.example.com
    service: "compat-service"
