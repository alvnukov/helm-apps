# Стабильность и надежность Helm Apps Library
<a id="top"></a>

Документ объясняет, на каком уровне библиотека гарантирует стабильность, за счет каких механизмов это достигается и где проходят границы гарантий.

Быстрая навигация:
- [Старт docs](README.md)
- [Quick Start](quickstart.md)
- [Decision Guide](decision-guide.md)
- [Architecture](architecture.md)
- [Reference](reference-values.md)
- [Operations](operations.md)

## 1. Цель по стабильности

Для библиотеки приоритет: **надежность и предсказуемость рендера выше скорости изменений**.

Практический критерий:
- изменения не должны ухудшать совместимость существующих values без явной причины;
- регрессии должны ловиться в CI до попадания в релиз.

## 2. Как достигается надежность

Текущая модель защиты состоит из нескольких слоев.

### 2.1 Валидация входа (values)

- JSON Schema: [`tests/.helm/values.schema.json`](../tests/.helm/values.schema.json)
- правила на типы и структуру полей;
- контракт на запрет native list в неразрешенных местах с явной ошибкой и путём до проблемного поля.

### 2.2 Контрактные сценарии рендера

- единый контрактный набор: [`tests/contracts/values.yaml`](../tests/contracts/values.yaml)
- покрыты все ключевые `apps-*` сущности;
- проверяется рендер важных полей и ожидаемых ресурсов.

<a id="param-k8s-api-compat"></a>
### 2.3 Совместимость Kubernetes API

- CI matrix по версиям Kubernetes (legacy + current);
- проверка выбора API-версий (`policy`, `batch`, `autoscaling` и др.);
- статическая валидация манифестов через `kubeconform`.

### 2.4 Live API-server проверка

- отдельный CI job с `kind`;
- установка совместимых CRD: [`tests/crds/compat-crds.yaml`](../tests/crds/compat-crds.yaml);
- `kubectl apply --dry-run=server` на контрактных манифестах.

### 2.5 Property-based проверки

- random-комбинации флагов/сущностей в contracts;
- детерминированный seed;
- запуск в CI через `scripts/fuzz-contracts.sh`: [`scripts/fuzz-contracts.sh`](../scripts/fuzz-contracts.sh).

## 3. Уровень гарантий

### 3.1 Что гарантируется

- библиотека стабильно рендерит поддерживаемые сущности в рамках контрактов;
- изменения проверяются на обратную совместимость в CI;
- типовые ошибки values обнаруживаются до деплоя.

### 3.2 Что не гарантируется как абсолют

- 100% покрытие всех возможных комбинаторных сочетаний пользовательских значений;
- корректность внешних CRD/операторов, если их фактический контракт в кластере отличается от ожидаемого;
- отсутствие рисков при полностью нестандартных custom-шаблонах пользователя.

## 4. Рекомендации пользователю для максимальной надежности

1. Всегда задавайте `global.env` явно.
2. Проверяйте рендер в целевой версии Kubernetes.
3. Используйте schema и contract-проверки как обязательный gate в CI.
4. Для custom renderer фиксируйте контракт входных полей и добавляйте свои контрактные тесты.
5. Для критичных сервисов добавляйте server-side dry-run в вашем pipeline.

## 5. Локальные команды проверки

Быстрый прогон:

```bash
bash scripts/ci-local.sh --skip-snapshot
```

Fuzz-проверки:

```bash
bash scripts/fuzz-contracts.sh --iterations 40 --seed 20260216
```
