# AGENTS-DEV.md

Практический гайд для AI-агентов по безопасной разработке `helm-apps`.
Документ основан на реальном цикле фикса `1.7.6` и проблемах, которые всплыли в CI/CD.

## 1. Цель агента

Агент должен:
- вносить изменения в библиотеку без неявных регрессий;
- держать совместимость рендера между разными Kubernetes-версиями;
- добавлять/обновлять проверки вместе с изменением поведения;
- выпускать релизы так, чтобы `Release Charts` проходил без ручных hotfix.

---

## 2. Базовые правила разработки

1. Изменение поведения библиотеки всегда сопровождается:
- обновлением документации;
- обновлением контрактов/снапшотов;
- обновлением CI-проверок (если меняется пайплайн или инструменты).

2. Любой fail-fast должен давать:
- стабильный error code (`E_*`);
- понятный `hint`;
- ссылку на docs.

3. Новые функции по умолчанию делать безопасными:
- opt-in флаги предпочтительнее opt-out;
- не ломать существующие селекторы/имена ресурсов.

4. Не использовать risky shortcut:
- если есть сомнение, сначала обнови тест/контракт, потом шаблон.

---

## 3. Env-контракт (критично)

### 3.1 Требование env

Для env-aware значений рендер должен падать, если env не задан:
- код ошибки: `E_ENV_REQUIRED`;
- ожидаемый смысл: окружение обязано задаваться на стадии render/deploy.

Источники env (приоритет):
1. `werf.env`
2. `global.env`

### 3.2 Важный нюанс про werf в CI

`werf helm template` может подмешивать пустой runtime env-контекст, что конфликтует с fail-fast логикой.

Вывод:
- для CI-рэндера и контрактных проверок использовать `helm template/lint`;
- `werf` оставлять там, где он действительно нужен, но не как обязательный рендерер для проверок контрактов.

---

## 4. Labels-контракт

Для env-лейбла используется opt-in:
- `global.labels.addEnv: true`
- добавляется label: `app.kubernetes.io/environment=<current env>`

Ограничения:
- добавляем только в `metadata.labels`;
- не использовать env label в `spec.selector.matchLabels` workload/service.

---

## 5. Обязательные проверки перед завершением задачи

Минимум:
```bash
helm lint tests/.helm --values tests/.helm/values.yaml
helm template contracts tests/contracts
```

Совместимость API:
```bash
helm template tests tests/.helm --set global.env=prod --set global._includes.apps-defaults.enabled=true --kube-version 1.29.0
helm template tests tests/.helm --set global.env=prod --set global._includes.apps-defaults.enabled=true --kube-version 1.20.15
```

Контракты:
```bash
bash scripts/check-contracts.sh
```

Если поведение рендера изменилось:
- обновить `tests/contracts/test_render.snapshot.yaml`.

---

## 6. Когда обязательно обновлять артефакты

Если меняется поведение библиотеки, агент обязан проверить и при необходимости обновить:
1. `charts/helm-apps/templates/*`
2. `tests/.helm/values.yaml`
3. `tests/.helm/values.schema.json`
4. `tests/contracts/*` (включая snapshot и проверки структуры)
5. `.github/workflows/*.yml` (если меняется expected toolchain)
6. `docs/*` и `CHANGELOG.md`

---

## 7. Release-процесс

1. Поднять версию в `charts/helm-apps/Chart.yaml`.
2. Обновить `CHANGELOG.md` (реальный fixed/added список).
3. Обновить lock-файлы тестовых чартов:
```bash
helm dependency update tests/.helm
helm dependency update tests/contracts
```
4. Прогнать проверки из раздела 5.
5. Коммит.
6. Тег версии (`1.x.y`) и push тега.
7. Проверить `Release Charts` run.
8. Проверить наличие GitHub release `helm-apps-<version>`.

---

## 8. Типичные ошибки и как их избегать

1. **CI падает с `E_ENV_REQUIRED` при `werf helm template`**
- Причина: пустой runtime env от werf.
- Решение: использовать `helm template` в CI/контракт-скриптах.

2. **Snapshot-дифф после смены рендерера**
- Причина: формат/нормализация вывода отличается.
- Решение: перегенерировать snapshot и прогнать `check-contracts.sh` повторно.

3. **Контракт-ассерты устарели**
- Причина: логика/приоритет env-map изменился.
- Решение: синхронизировать `scripts/verify-contracts-structure.rb` с текущим контрактом.

---

## 9. Стандарт ответа агента пользователю

После выполнения задачи агент должен сообщать:
1. Что именно изменено (по файлам).
2. Какие проверки прогнаны и их статус.
3. Что не удалось прогнать (если есть) и почему.
4. Готовность к релизу (да/нет) и следующий шаг.

---

## 10. Итоговая инженерная позиция

- Стабильность выше удобства локальных shortcuts.
- Контрактные проверки и релизный workflow должны быть детерминированными.
- Любой AI-агент обязан сначала сохранить совместимость и только потом оптимизировать процесс.
