# happ

`happ` is a CLI tool for importing existing application definitions into the `helm-apps` library format.

It supports:
- Helm charts (`helm template`-based import)
- Raw Kubernetes manifests
- Docker Compose (inspect + import MVP)
- Interactive web UI for chart/compose analysis
- Built-in semantic YAML diff (`happ dyff`) without external `dyff` binary

## What `happ` Generates

`happ` can generate:
- `helm-apps`-style `values.yaml`
- a full consumer chart based on the `helm-apps` library (`Chart.yaml`, `values.yaml`, templates)
- analysis reports (template analysis / compose graph)
- source-vs-library render comparisons (inspect UI)

## Design Priorities

- Prefer built-in `apps-*` sections when possible
- Fallback to native generic `apps-k8s-manifests` for unsupported/unmapped resources
- Preserve rendering equivalence where feasible
- Be explicit about mismatches (compare UI / `dyff`)

## Installation / Running

From source:

```bash
cd /Users/zol/src/helm-apps/cmd/happ
go run . --help
```

Build binary:

```bash
cd /Users/zol/src/helm-apps/cmd/happ
go build -o happ .
./happ --help
```

## External Dependencies

`happ` runtime dependencies depend on mode:

- Required for Helm chart render/import:
  - `helm` (CLI binary), because chart import uses `helm template`
- Not required anymore:
  - `dyff` (replaced by built-in `dyfflike` engine)
- Optional UX:
  - browser opener command (`open` / `xdg-open` / Windows shell) for `--web`

## Commands Overview

### 1. `happ chart`

Imports a Helm chart by rendering it locally and converting resulting manifests into `helm-apps` values.

Typical flow:
1. `helm template` chart with provided values/sets
2. parse manifests
3. map resources into built-in `apps-*` sections (when possible)
4. fallback unknown/unsupported resources into `apps-k8s-manifests`
5. optionally generate a consumer chart and verify equivalence

Example:

```bash
cd /Users/zol/src/helm-apps/cmd/happ
go run . chart \
  --path /path/to/chart \
  --values /path/to/values.yaml \
  --set image.tag=1.2.3 \
  --out-chart-dir /tmp/my-app \
  --verify-equivalence
```

#### Chart render flags

- `--path`
- `--release-name`
- `--namespace`
- `--values` (repeatable)
- `--set` (repeatable)
- `--set-string` (repeatable)
- `--set-file` (repeatable)
- `--set-json` (repeatable)
- `--kube-version`
- `--api-version` (repeatable)
- `--include-crds`
- `--write-rendered-output`

#### Import flags (shared)

- `--env`
- `--group-name`
- `--group-type`
- `--import-strategy raw|helpers-experimental`
- `--min-include-bytes`
- `--include-status`
- `--output`
- `--out-chart-dir`
- `--chart-name`
- `--library-chart-path`
- `--write-renderer-template` (legacy/custom-group path only; native fallback usually does not need it)

#### Validation / analysis flags

- `--verify-equivalence`
- `--analyze-templates`
- `--analyze-report`
- `--helm-exec-timeout`
- `--analyze-timeout`
- `--verify-timeout`
- `--pipeline-timeout`

### 2. `happ manifests`

Imports raw Kubernetes YAML manifests (file or directory) into `helm-apps` values/chart.

Example:

```bash
cd /Users/zol/src/helm-apps/cmd/happ
go run . manifests \
  --path ./rendered-manifests \
  --out-chart-dir /tmp/my-app
```

Notes:
- No `helm` binary required
- `--verify-equivalence` and `--analyze-templates` are not supported in this mode

### 3. `happ compose`

Imports Docker Compose into `helm-apps` values (MVP, app-centric).

Current MVP covers:
- services -> `apps-stateless`
- image / env / ports
- `command`, `entrypoint`, `working_dir`
- compose `healthcheck` -> `readinessProbe`
- optional duplication into `livenessProbe`

Example:

```bash
cd /Users/zol/src/helm-apps/cmd/happ
go run . compose \
  --path /path/to/docker-compose.yml \
  --out-chart-dir /tmp/my-compose-app
```

Opt-in liveness probe:

```bash
go run . compose \
  --path /path/to/docker-compose.yml \
  --compose-healthcheck-to-liveness
```

Important:
- Compose import intentionally does not invent fields not present in Compose.
- Internal K8s Service inference for DB/cache containers without `ports/expose` is not auto-generated by default.

### 4. `happ inspect`

Interactive web UI for Helm chart analysis.

Features:
- renders chart with provided values/set flags
- visualizes resources and relations
- template analysis (`.Values` usage, pipes, risky constructs)
- `helm-apps` preview
- interactive values lab (edit chart `values.yaml`, rerender, compare)
- source chart render vs library render comparison

Example:

```bash
cd /Users/zol/src/helm-apps/cmd/happ
go run . inspect \
  --path /path/to/chart \
  --values /path/to/values.yaml \
  --web \
  --addr 127.0.0.1:8088
```

Inspect defaults:
- `--web=true`
- opens browser automatically (`--open-browser`, disable with `--no-open-browser`)
- preview import strategy defaults to `helpers-experimental`

Useful flags:
- same Helm render flags as `chart`
- `--env`
- `--group-name`, `--group-type`
- `--import-strategy`
- `--analyze-templates` (default true for inspect)
- `--analyze-report`
- timeouts (`--helm-exec-timeout`, `--analyze-timeout`, `--pipeline-timeout`)

### 5. `happ compose-inspect`

Interactive (or report-only) inspection of Docker Compose with relationship graph + `helm-apps` preview.

Features:
- parse compose file/dir
- graph/report of services, resources, relations
- web UI with source compose YAML syntax highlight
- generated `helm-apps` preview (compose import MVP output)

CLI report:

```bash
cd /Users/zol/src/helm-apps/cmd/happ
go run . compose-inspect \
  --path /path/to/docker-compose.yml \
  --format yaml
```

Web UI:

```bash
cd /Users/zol/src/helm-apps/cmd/happ
go run . compose-inspect \
  --path /path/to/docker-compose.yml \
  --web \
  --addr 127.0.0.1:8089
```

Flags:
- `--path`
- `--format yaml|json`
- `--output`
- `--web`
- `--addr`
- `--open-browser`, `--no-open-browser`
- `--env` (for preview `global.env`)
- `--compose-healthcheck-to-liveness`

### 6. `happ dyff`

Built-in semantic YAML diff for terminal and CI usage.

This does **not** require external `dyff`.

#### Core UX features

- semantic list matching (identifier-based when possible)
- ignore-order by default
- Kubernetes multi-doc matching (`apiVersion/kind/namespace/name`)
- colorized terminal output
- JSON mode
- CI-friendly exit codes
- stdin support

#### Examples

Basic:

```bash
cd /Users/zol/src/helm-apps/cmd/happ
go run . dyff before.yaml after.yaml
```

CI mode (exit non-zero on diff):

```bash
go run . dyff before.yaml after.yaml --quiet --fail-on-diff
```

Color + labels:

```bash
go run . dyff before.yaml after.yaml \
  --color always \
  --label-from source-chart \
  --label-to library-render
```

JSON output:

```bash
go run . dyff before.yaml after.yaml --format json
```

stdin + stats:

```bash
cat before.yaml | go run . dyff --from - --to after.yaml --stats
```

Flags can be interspersed with positional args:

```bash
go run . dyff before.yaml --no-color after.yaml --stats
```

#### `dyff` flags

- `--from`, `--to` (or two positional args)
- `--output`
- `--quiet`
- `--fail-on-diff`
- `--ignore-order` (default true)
- `--respect-order`
- `--ignore-whitespace`
- `--id` (repeatable)
- `--color auto|always|never`
- `--no-color`
- `--format text|json`
- `--stats`
- `--label-from`
- `--label-to`

#### Exit code behavior (`dyff`)

- `0` — equal (or diff printed without `--fail-on-diff`)
- `1` — CLI/runtime error, or differences found when `--fail-on-diff` is set

## Import Strategies

### `raw`

Conservative fallback-oriented import.

- maximal compatibility
- more data ends up in generic sections
- useful for difficult charts

### `helpers-experimental`

Aggressive library-style mapping using built-in groups and helpers.

Targets include (coverage evolves over time):
- `apps-stateless`, `apps-jobs`, `apps-cronjobs`
- `apps-services`, `apps-ingresses`, `apps-network-policies`
- `apps-configmaps`, `apps-secrets`
- `apps-service-accounts`
- fallback to `apps-k8s-manifests` for unsupported/ambiguous cases

## Web UI Highlights

### Chart Inspect UI (`happ inspect`)

- Applications view (workload-centric grouping)
- Resources view
- Import plan hints
- `helm-apps` render preview
- compare source chart render vs library render
- YAML folding, filters, sticky toolbars
- settings persistence (session + cookies)

### Compose Inspect UI (`happ compose-inspect --web`)

- source `docker-compose.yml` preview with syntax highlighting
- services/resources/relations tables
- selected service details (including command/entrypoint/healthcheck)
- generated `helm-apps` preview

## Timeouts

Timeouts are configurable (depending on mode):

- `--helm-exec-timeout`
- `--analyze-timeout`
- `--verify-timeout`
- `--pipeline-timeout`

`inspect --web` excludes the long-lived web serving phase from pipeline timeout.

## Limitations / Known Tradeoffs

- Helm chart import still depends on `helm template` CLI (Helm SDK backend is not implemented)
- `helpers-experimental` is intentionally conservative in ambiguous mappings
- Docker Compose import is MVP and does not cover every Compose field semantically yet
- Some differences in compare are intentionally normalized (library-specific metadata, null-vs-absent, order-insensitive list cases)

## Development Notes

Run tests:

```bash
cd /Users/zol/src/helm-apps/cmd/happ
GOCACHE=/tmp/go-build-happ go test ./...
```

Run linter:

```bash
cd /Users/zol/src/helm-apps/cmd/happ
PATH=/Users/zol/src/helm-apps/.tmp/bin:$PATH golangci-lint run
```

Coverage:
- core diff engine lives in `/Users/zol/src/helm-apps/cmd/happ/internal/dyfflike`
- terminal formatter lives in `/Users/zol/src/helm-apps/cmd/happ/internal/dyffcli`

