name: CI

on:
  pull_request:
  push:
    branches-ignore:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set lib version
        run: |
          LIB_VERSION=$(sed -n '/version/{s/version: //;p;}' charts/helm-apps/Chart.yaml)
          sed -i 's/_FLANT_APPS_LIBRARY_VERSION_/'${LIB_VERSION}'/' charts/helm-apps/templates/_apps-version.tpl

      - name: Install Helm3
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Install Dyff
        run: |
          curl --silent --location https://git.io/JYfAY | bash

      - name: Update test chart dependencies
        run: |
          helm dependency update tests/.helm

      - name: Validate values schema
        run: |
          helm lint tests/.helm --values tests/.helm/values.yaml

      - name: Render
        run: |
          set -e
          helm template tests tests/.helm \
            --set "global.env=prod" \
            --set "global._includes.apps-defaults.enabled=true" > /tmp/tests_render.yaml

      - name: Test render snapshot
        run: |
          set -e
          helm template tests tests/.helm \
            --set "global.env=prod" \
            --set "global._includes.apps-defaults.enabled=true" > /tmp/test_render_check.yaml
          dyff between tests/test_render.yaml /tmp/test_render_check.yaml | tee /tmp/test_render_check
          check_tests=$(sed 1,7d /tmp/test_render_check | wc -l)
          if [ $check_tests -gt "7" ]; then exit 1; fi

      - name: Update contract chart dependencies
        run: |
          helm dependency update tests/contracts

      - name: Contract test for include merge behavior
        run: |
          set -euo pipefail
          helm template contracts tests/contracts > /tmp/contracts_render.yaml

          # Include order override and local override precedence.
          grep -q '"A": "2"' /tmp/contracts_render.yaml
          grep -q '"LOCAL": "ok"' /tmp/contracts_render.yaml
          grep -q '"key2": "local-value-2"' /tmp/contracts_render.yaml

          # Recursive merge and _include list concatenation from base-a/base-b.
          grep -q '"key1": "value-1"' /tmp/contracts_render.yaml
          grep -q '"fromBaseA": "A"' /tmp/contracts_render.yaml
          grep -q '"fromBaseB": "B"' /tmp/contracts_render.yaml

          # Env-map behavior:
          # production resolves explicit env key from base profile.
          grep -q '"ENV_SWITCH": "base-production"' /tmp/contracts_render.yaml

          # non-production resolves _default from higher-priority include.
          helm template contracts tests/contracts --set global.env=dev > /tmp/contracts_render_dev.yaml
          grep -q '"ENV_SWITCH": "override-default"' /tmp/contracts_render_dev.yaml
