name: CI

on:
  pull_request:
  push:
    branches-ignore:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set lib version
        run: |
          LIB_VERSION=$(sed -n '/version/{s/version: //;p;}' charts/helm-apps/Chart.yaml)
          sed -i 's/_FLANT_APPS_LIBRARY_VERSION_/'${LIB_VERSION}'/' charts/helm-apps/templates/_apps-version.tpl

      - name: Install werf CLI
        uses: werf/actions/install@v1.2
        with:
          channel: ea

      - name: Install Dyff
        run: |
          curl --silent --location https://git.io/JYfAY | bash

      - name: Install kubeconform
        run: |
          set -euo pipefail
          KUBECONFORM_VERSION=0.6.7
          curl -sSL -o /tmp/kubeconform.tar.gz "https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz"
          tar -xzf /tmp/kubeconform.tar.gz -C /tmp kubeconform
          sudo install -m 0755 /tmp/kubeconform /usr/local/bin/kubeconform

      - name: Update test chart dependencies
        run: |
          werf helm dependency update tests/.helm

      - name: Validate values schema
        run: |
          werf helm lint tests/.helm --values tests/.helm/values.yaml

      - name: Verify Kubernetes API compatibility
        run: |
          set -euo pipefail

          # New clusters: stable APIs must be rendered.
          werf helm template tests tests/.helm \
            --set "global.env=prod" \
            --set "global._includes.apps-defaults.enabled=true" \
            --kube-version 1.29.0 > /tmp/tests_k8s_129.yaml
          grep -q '^apiVersion: policy/v1$' /tmp/tests_k8s_129.yaml
          grep -q '^apiVersion: batch/v1$' /tmp/tests_k8s_129.yaml
          grep -q '^apiVersion: autoscaling/v2$' /tmp/tests_k8s_129.yaml
          ! grep -q '^apiVersion: policy/v1beta1$' /tmp/tests_k8s_129.yaml
          ! grep -q '^apiVersion: batch/v1beta1$' /tmp/tests_k8s_129.yaml
          ! grep -q '^apiVersion: autoscaling/v2beta2$' /tmp/tests_k8s_129.yaml
          kubeconform -strict -summary -ignore-missing-schemas -kubernetes-version 1.29.0 /tmp/tests_k8s_129.yaml

          # Legacy clusters: beta APIs remain supported.
          werf helm template tests tests/.helm \
            --set "global.env=prod" \
            --set "global._includes.apps-defaults.enabled=true" \
            --kube-version 1.20.15 > /tmp/tests_k8s_120.yaml
          grep -q '^apiVersion: policy/v1beta1$' /tmp/tests_k8s_120.yaml
          grep -q '^apiVersion: batch/v1beta1$' /tmp/tests_k8s_120.yaml
          grep -q '^apiVersion: autoscaling/v2beta2$' /tmp/tests_k8s_120.yaml
          ! grep -q '^apiVersion: autoscaling/v2$' /tmp/tests_k8s_120.yaml
          kubeconform -strict -summary -ignore-missing-schemas -kubernetes-version 1.20.15 /tmp/tests_k8s_120.yaml

      - name: Render
        run: |
          set -e
          source $(werf ci-env github --as-file)
          cd tests && werf render --dev --set "global._includes.apps-defaults.enabled=true" --env=prod

      - name: Test render snapshot
        run: |
          set -e
          source $(werf ci-env github --as-file)
          cd tests && werf render --dev --set "global._includes.apps-defaults.enabled=true" --env=prod | sed '/werf.io\//d' > test_render_check.yaml
          dyff between test_render.yaml test_render_check.yaml | tee /tmp/test_render_check
          check_tests=$(sed 1,7d /tmp/test_render_check | wc -l)
          if [ $check_tests -gt "7" ]; then exit 1; fi

      - name: Update contract chart dependencies
        run: |
          werf helm dependency update tests/contracts

      - name: Check apps entity coverage in contracts
        run: |
          set -euo pipefail
          bash scripts/check-entity-coverage.sh

      - name: Contract test for include merge behavior
        run: |
          set -euo pipefail
          werf helm template contracts tests/contracts --set global.env=production > /tmp/contracts_render.yaml

          # Include order override and local override precedence.
          grep -q '"A": "2"' /tmp/contracts_render.yaml
          grep -q '"LOCAL": "ok"' /tmp/contracts_render.yaml
          grep -q '"key2": "local-value-2"' /tmp/contracts_render.yaml

          # Recursive merge and _include list concatenation from base-a/base-b.
          grep -q '"key1": "value-1"' /tmp/contracts_render.yaml
          grep -q '"fromBaseA": "A"' /tmp/contracts_render.yaml
          grep -q '"fromBaseB": "B"' /tmp/contracts_render.yaml

          # Env-map behavior:
          # production also resolves to override-default from higher-priority include.
          grep -q '"ENV_SWITCH": "override-default"' /tmp/contracts_render.yaml

          # non-production resolves _default from higher-priority include.
          werf helm template contracts tests/contracts --set global.env=dev > /tmp/contracts_render_dev.yaml
          grep -q '"ENV_SWITCH": "override-default"' /tmp/contracts_render_dev.yaml

          # Generic passthrough fields support.
          grep -q 'paused: true' /tmp/contracts_render.yaml
          grep -q 'resizePolicy:' /tmp/contracts_render.yaml
          grep -q 'podFailurePolicy:' /tmp/contracts_render.yaml
          grep -q 'defaultBackend:' /tmp/contracts_render.yaml
          grep -q 'volumeMode: Filesystem' /tmp/contracts_render.yaml
          grep -q 'immutable: true' /tmp/contracts_render.yaml
          grep -q 'stringData:' /tmp/contracts_render.yaml
          grep -q '^apiVersion: networking.k8s.io/v1$' /tmp/contracts_render.yaml
          grep -q '^kind: NetworkPolicy$' /tmp/contracts_render.yaml
          grep -q '^apiVersion: cilium.io/v2$' /tmp/contracts_render.yaml
          grep -q '^kind: CiliumNetworkPolicy$' /tmp/contracts_render.yaml
          grep -q '^apiVersion: projectcalico.org/v3$' /tmp/contracts_render.yaml
          grep -q 'selector: "app == '\''compat-service'\''"' /tmp/contracts_render.yaml
          grep -q 'kubernetes.io/metadata.name: ingress-nginx' /tmp/contracts_render.yaml
          grep -q 'port: 53' /tmp/contracts_render.yaml
          grep -q 'name: "release-auto-app"' /tmp/contracts_render.yaml
          grep -q 'image: alpine:3.19' /tmp/contracts_render.yaml
          grep -q 'helm-apps/release: "production-v1"' /tmp/contracts_render.yaml
          grep -q 'helm-apps/app-version: "3.19"' /tmp/contracts_render.yaml
          grep -q 'name: "compat-route"' /tmp/contracts_render.yaml
          grep -q 'host: "route.example.com"' /tmp/contracts_render.yaml
          grep -q '^kind: StatefulSet$' /tmp/contracts_render.yaml
          grep -q 'name: "compat-stateful"' /tmp/contracts_render.yaml
          grep -q '^kind: CronJob$' /tmp/contracts_render.yaml
          grep -q 'name: "compat-cron"' /tmp/contracts_render.yaml
          grep -q '^kind: Service$' /tmp/contracts_render.yaml
          grep -q 'name: "compat-standalone-service"' /tmp/contracts_render.yaml
          grep -q '^kind: LimitRange$' /tmp/contracts_render.yaml
          grep -q 'name: "compat-limit-range"' /tmp/contracts_render.yaml
          grep -q '^apiVersion: cert-manager.io/v1$' /tmp/contracts_render.yaml
          grep -q '^kind: Certificate$' /tmp/contracts_render.yaml
          grep -q 'name: compat-certificate' /tmp/contracts_render.yaml
          grep -q '^kind: DexAuthenticator$' /tmp/contracts_render.yaml
          grep -q 'name: "compat-dex-auth"' /tmp/contracts_render.yaml
          grep -q '^kind: DexClient$' /tmp/contracts_render.yaml
          grep -q 'name: "compat-dex-client"' /tmp/contracts_render.yaml
          grep -q '^kind: CustomPrometheusRules$' /tmp/contracts_render.yaml
          grep -q 'name: compat-rules' /tmp/contracts_render.yaml
          grep -q '^kind: GrafanaDashboardDefinition$' /tmp/contracts_render.yaml
          grep -q 'name: "compat-dashboard"' /tmp/contracts_render.yaml
          grep -q '^kind: Kafka$' /tmp/contracts_render.yaml
          grep -q 'name: compat-kafka-' /tmp/contracts_render.yaml
          grep -q '^kind: KafkaTopic$' /tmp/contracts_render.yaml
          grep -q 'name: compat-topic' /tmp/contracts_render.yaml
          grep -q '^kind: NodeUser$' /tmp/contracts_render.yaml
          grep -q 'name: "compat-user"' /tmp/contracts_render.yaml
          grep -q '^kind: NodeGroup$' /tmp/contracts_render.yaml
          grep -q 'name: "compat-group"' /tmp/contracts_render.yaml

          # Strict mode (opt-in) for network policies:
          # valid config should render, unknown keys should fail.
          werf helm template contracts tests/contracts --set global.env=production --set global.validation.strict=true > /tmp/contracts_render_strict.yaml
          grep -Eq '"custom": ?"ok"|custom: ?"?ok"?' /tmp/contracts_render_strict.yaml
          ! werf helm template contracts tests/contracts \
            --set global.env=production \
            --set global.validation.strict=true \
            --set apps-network-policies.compat-netpol.typoField=1 >/tmp/contracts_render_strict_fail.yaml
          ! werf helm template contracts tests/contracts \
            --set global.env=production \
            --set global.validation.strict=true \
            --set apps-typo.bad.enabled=true >/tmp/contracts_render_strict_top_fail.yaml

          # Service spec compatibility by Kubernetes version.
          werf helm template contracts tests/contracts --set global.env=production --kube-version 1.29.0 > /tmp/contracts_render_129.yaml
          grep -q 'loadBalancerClass: "internal-vip"' /tmp/contracts_render_129.yaml
          grep -q 'internalTrafficPolicy: "Local"' /tmp/contracts_render_129.yaml

          werf helm template contracts tests/contracts --set global.env=production --kube-version 1.20.15 > /tmp/contracts_render_120.yaml
          ! grep -q 'loadBalancerClass:' /tmp/contracts_render_120.yaml
          ! grep -q 'internalTrafficPolicy:' /tmp/contracts_render_120.yaml
          grep -q 'ipFamilyPolicy: "SingleStack"' /tmp/contracts_render_120.yaml
          grep -q 'allocateLoadBalancerNodePorts: true' /tmp/contracts_render_120.yaml

          werf helm template contracts tests/contracts --set global.env=production --kube-version 1.19.16 > /tmp/contracts_render_119.yaml
          ! grep -q 'loadBalancerClass:' /tmp/contracts_render_119.yaml
          ! grep -q 'internalTrafficPolicy:' /tmp/contracts_render_119.yaml
          ! grep -q 'ipFamilyPolicy:' /tmp/contracts_render_119.yaml
          ! grep -q 'ipFamilies:' /tmp/contracts_render_119.yaml
          ! grep -q 'allocateLoadBalancerNodePorts:' /tmp/contracts_render_119.yaml

          # Native YAML lists are forbidden in values (except _include/_include_files).
          cat > /tmp/contracts_invalid_native_list.yaml <<'EOF'
          apps-stateless:
            compat-service:
              service:
                ports:
                  - name: http
                    port: 80
                    targetPort: 8080
          EOF
          ! werf helm template contracts tests/contracts \
            --set global.env=production \
            --values /tmp/contracts_invalid_native_list.yaml \
            >/tmp/contracts_invalid_native_list.out 2>/tmp/contracts_invalid_native_list.err
          grep -q "list value is not allowed at Values.apps-stateless.compat-service.service.ports" /tmp/contracts_invalid_native_list.err

      - name: Contract test for internal-like release/deploy flow
        run: |
          set -euo pipefail
          werf helm template contracts tests/contracts \
            --set global.env=production \
            --values tests/contracts/values.internal-compat.yaml > /tmp/contracts_internal_like.yaml
          grep -q 'name: "compat-web"' /tmp/contracts_internal_like.yaml
          grep -q 'image: alpine:1.2.3' /tmp/contracts_internal_like.yaml
          grep -q 'helm-apps/release:' /tmp/contracts_internal_like.yaml
          grep -q 'helm-apps/app-version: "1.2.3"' /tmp/contracts_internal_like.yaml
          grep -q 'name: "compat-route"' /tmp/contracts_internal_like.yaml
          grep -q 'host: "compat.example.com"' /tmp/contracts_internal_like.yaml

      - name: Property-based fuzz checks for contracts
        run: |
          set -euo pipefail
          bash scripts/fuzz-contracts.sh --iterations 40 --seed 20260216

  kube-compatibility-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - kube_version: "1.19.16"
            expect_policy: "policy/v1beta1"
            expect_cronjob: "batch/v1beta1"
            expect_hpa: "autoscaling/v2beta2"
          - kube_version: "1.20.15"
            expect_policy: "policy/v1beta1"
            expect_cronjob: "batch/v1beta1"
            expect_hpa: "autoscaling/v2beta2"
          - kube_version: "1.23.17"
            expect_policy: "policy/v1"
            expect_cronjob: "batch/v1"
            expect_hpa: "autoscaling/v2"
          - kube_version: "1.29.0"
            expect_policy: "policy/v1"
            expect_cronjob: "batch/v1"
            expect_hpa: "autoscaling/v2"
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set lib version
        run: |
          LIB_VERSION=$(sed -n '/version/{s/version: //;p;}' charts/helm-apps/Chart.yaml)
          sed -i 's/_FLANT_APPS_LIBRARY_VERSION_/'${LIB_VERSION}'/' charts/helm-apps/templates/_apps-version.tpl

      - name: Install werf CLI
        uses: werf/actions/install@v1.2
        with:
          channel: ea

      - name: Install kubeconform
        run: |
          set -euo pipefail
          KUBECONFORM_VERSION=0.6.7
          curl -sSL -o /tmp/kubeconform.tar.gz "https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz"
          tar -xzf /tmp/kubeconform.tar.gz -C /tmp kubeconform
          sudo install -m 0755 /tmp/kubeconform /usr/local/bin/kubeconform

      - name: Update chart dependencies
        run: |
          werf helm dependency update tests/.helm
          werf helm dependency update tests/contracts

      - name: Render and verify APIs for Kubernetes ${{ matrix.kube_version }}
        run: |
          set -euo pipefail

          werf helm template tests tests/.helm \
            --set "global.env=prod" \
            --set "global._includes.apps-defaults.enabled=true" \
            --kube-version "${{ matrix.kube_version }}" > "/tmp/tests_k8s_${{ matrix.kube_version }}.yaml"

          grep -q "^apiVersion: ${{ matrix.expect_policy }}$" "/tmp/tests_k8s_${{ matrix.kube_version }}.yaml"
          grep -q "^apiVersion: ${{ matrix.expect_cronjob }}$" "/tmp/tests_k8s_${{ matrix.kube_version }}.yaml"
          grep -q "^apiVersion: ${{ matrix.expect_hpa }}$" "/tmp/tests_k8s_${{ matrix.kube_version }}.yaml"

          kubeconform -strict -summary -ignore-missing-schemas \
            -kubernetes-version "${{ matrix.kube_version }}" \
            "/tmp/tests_k8s_${{ matrix.kube_version }}.yaml"

      - name: Render contracts for Kubernetes ${{ matrix.kube_version }}
        run: |
          set -euo pipefail
          werf helm template contracts tests/contracts \
            --set global.env=production \
            --kube-version "${{ matrix.kube_version }}" > "/tmp/contracts_k8s_${{ matrix.kube_version }}.yaml"
          grep -q '^apiVersion:' "/tmp/contracts_k8s_${{ matrix.kube_version }}.yaml"

  kube-server-dry-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set lib version
        run: |
          LIB_VERSION=$(sed -n '/version/{s/version: //;p;}' charts/helm-apps/Chart.yaml)
          sed -i 's/_FLANT_APPS_LIBRARY_VERSION_/'${LIB_VERSION}'/' charts/helm-apps/templates/_apps-version.tpl

      - name: Install werf CLI
        uses: werf/actions/install@v1.2
        with:
          channel: ea

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.0

      - name: Create kind cluster
        uses: helm/kind-action@v1.10.0
        with:
          node_image: kindest/node:v1.29.2

      - name: Install compatibility CRDs
        run: |
          set -euo pipefail
          kubectl apply -f tests/crds/compat-crds.yaml
          kubectl wait --for=condition=Established --timeout=120s crd --all

      - name: Update chart dependencies
        run: |
          werf helm dependency update tests/.helm
          werf helm dependency update tests/contracts

      - name: Render contracts for server-side validation
        run: |
          set -euo pipefail
          werf helm template contracts tests/contracts \
            --set "global.env=production" \
            --kube-version 1.29.0 \
            --set "apps-jobs.compat-job.restartPolicy=Never" \
            --set "apps-cronjobs.compat-cron.restartPolicy=Never" \
            --set "apps-kafka-strimzi.compat-kafka.enabled=false" \
            --set "apps-infra.node-groups.compat-group.enabled=false" \
            > /tmp/contracts_k8s_129_server.yaml

      - name: Server-side dry-run apply
        run: |
          set -euo pipefail
          kubectl apply --dry-run=server -f /tmp/contracts_k8s_129_server.yaml
