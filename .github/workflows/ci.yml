name: CI

on:
  pull_request:
  push:
    branches-ignore:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set lib version
        run: |
          LIB_VERSION=$(sed -n '/version/{s/version: //;p;}' charts/helm-apps/Chart.yaml)
          sed -i 's/_FLANT_APPS_LIBRARY_VERSION_/'${LIB_VERSION}'/' charts/helm-apps/templates/_apps-version.tpl

      - name: Install werf CLI
        uses: werf/actions/install@v2
        with:
          version: v2.57.1

      - name: Setup Go (for happ)
        uses: actions/setup-go@v5
        with:
          go-version-file: cmd/happ/go.mod

      - name: Setup golangci-lint (for happ)
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.64.8
          install-mode: binary
          skip-cache: true
          skip-save-cache: true

      - name: Install Dyff
        run: |
          curl --silent --location https://git.io/JYfAY | bash

      - name: Install kubeconform
        run: |
          set -euo pipefail
          KUBECONFORM_VERSION=0.6.7
          curl -sSL -o /tmp/kubeconform.tar.gz "https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz"
          tar -xzf /tmp/kubeconform.tar.gz -C /tmp kubeconform
          sudo install -m 0755 /tmp/kubeconform /usr/local/bin/kubeconform

      - name: Update test chart dependencies
        run: |
          werf helm dependency update tests/.helm

      - name: Validate values schema
        run: |
          werf helm lint tests/.helm --values tests/.helm/values.yaml

      - name: Verify Kubernetes API compatibility
        run: |
          set -euo pipefail

          # New clusters: stable APIs must be rendered.
          werf helm template tests tests/.helm \
            --set "global.env=prod" \
            --set "global._includes.apps-defaults.enabled=true" \
            --kube-version 1.29.0 > /tmp/tests_k8s_129.yaml
          grep -q '^apiVersion: policy/v1$' /tmp/tests_k8s_129.yaml
          grep -q '^apiVersion: batch/v1$' /tmp/tests_k8s_129.yaml
          grep -q '^apiVersion: autoscaling/v2$' /tmp/tests_k8s_129.yaml
          ! grep -q '^apiVersion: policy/v1beta1$' /tmp/tests_k8s_129.yaml
          ! grep -q '^apiVersion: batch/v1beta1$' /tmp/tests_k8s_129.yaml
          ! grep -q '^apiVersion: autoscaling/v2beta2$' /tmp/tests_k8s_129.yaml
          kubeconform -strict -summary -ignore-missing-schemas -kubernetes-version 1.29.0 /tmp/tests_k8s_129.yaml

          # Legacy clusters: beta APIs remain supported.
          werf helm template tests tests/.helm \
            --set "global.env=prod" \
            --set "global._includes.apps-defaults.enabled=true" \
            --kube-version 1.20.15 > /tmp/tests_k8s_120.yaml
          grep -q '^apiVersion: policy/v1beta1$' /tmp/tests_k8s_120.yaml
          grep -q '^apiVersion: batch/v1beta1$' /tmp/tests_k8s_120.yaml
          grep -q '^apiVersion: autoscaling/v2beta2$' /tmp/tests_k8s_120.yaml
          ! grep -q '^apiVersion: autoscaling/v2$' /tmp/tests_k8s_120.yaml
          kubeconform -strict -summary -ignore-missing-schemas -kubernetes-version 1.20.15 /tmp/tests_k8s_120.yaml

      - name: Render
        run: |
          set -e
          source $(werf ci-env github --as-file)
          cd tests && werf render --dev --set "global._includes.apps-defaults.enabled=true" --env=prod

      - name: Test render snapshot
        run: |
          set -e
          source $(werf ci-env github --as-file)
          ruby scripts/validate-yaml-stream.rb tests/test_render.yaml
          cd tests && werf render --dev --set "global._includes.apps-defaults.enabled=true" --env=prod | sed '/werf.io\//d' > test_render_check.yaml
          ruby ../scripts/validate-yaml-stream.rb test_render_check.yaml
          dyff between test_render.yaml test_render_check.yaml | tee /tmp/test_render_check
          check_tests=$(sed 1,7d /tmp/test_render_check | wc -l)
          if [ $check_tests -gt "7" ]; then exit 1; fi

      - name: Check apps entity coverage in contracts
        run: |
          set -euo pipefail
          bash scripts/check-entity-coverage.sh

      - name: Contract checks (snapshot + structural + negative)
        run: |
          set -euo pipefail
          bash scripts/check-contracts.sh

      - name: Property-based fuzz checks for contracts
        run: |
          set -euo pipefail
          bash scripts/fuzz-contracts.sh --iterations 40 --seed 20260216

      - name: Sync happ embedded library asset
        run: |
          set -euo pipefail
          cd cmd/happ
          go generate ./assets

      - name: Lint happ
        run: |
          set -euo pipefail
          cd cmd/happ
          golangci-lint run

      - name: Test happ
        run: |
          set -euo pipefail
          cd cmd/happ
          go test ./...

  kube-compatibility-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - kube_version: "1.19.16"
            expect_policy: "policy/v1beta1"
            expect_cronjob: "batch/v1beta1"
            expect_hpa: "autoscaling/v2beta2"
          - kube_version: "1.20.15"
            expect_policy: "policy/v1beta1"
            expect_cronjob: "batch/v1beta1"
            expect_hpa: "autoscaling/v2beta2"
          - kube_version: "1.23.17"
            expect_policy: "policy/v1"
            expect_cronjob: "batch/v1"
            expect_hpa: "autoscaling/v2"
          - kube_version: "1.29.0"
            expect_policy: "policy/v1"
            expect_cronjob: "batch/v1"
            expect_hpa: "autoscaling/v2"
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set lib version
        run: |
          LIB_VERSION=$(sed -n '/version/{s/version: //;p;}' charts/helm-apps/Chart.yaml)
          sed -i 's/_FLANT_APPS_LIBRARY_VERSION_/'${LIB_VERSION}'/' charts/helm-apps/templates/_apps-version.tpl

      - name: Install werf CLI
        uses: werf/actions/install@v2
        with:
          version: v2.57.1

      - name: Install kubeconform
        run: |
          set -euo pipefail
          KUBECONFORM_VERSION=0.6.7
          curl -sSL -o /tmp/kubeconform.tar.gz "https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz"
          tar -xzf /tmp/kubeconform.tar.gz -C /tmp kubeconform
          sudo install -m 0755 /tmp/kubeconform /usr/local/bin/kubeconform

      - name: Update chart dependencies
        run: |
          werf helm dependency update tests/.helm
          werf helm dependency update tests/contracts

      - name: Render and verify APIs for Kubernetes ${{ matrix.kube_version }}
        run: |
          set -euo pipefail

          werf helm template tests tests/.helm \
            --set "global.env=prod" \
            --set "global._includes.apps-defaults.enabled=true" \
            --kube-version "${{ matrix.kube_version }}" > "/tmp/tests_k8s_${{ matrix.kube_version }}.yaml"

          grep -q "^apiVersion: ${{ matrix.expect_policy }}$" "/tmp/tests_k8s_${{ matrix.kube_version }}.yaml"
          grep -q "^apiVersion: ${{ matrix.expect_cronjob }}$" "/tmp/tests_k8s_${{ matrix.kube_version }}.yaml"
          grep -q "^apiVersion: ${{ matrix.expect_hpa }}$" "/tmp/tests_k8s_${{ matrix.kube_version }}.yaml"

          kubeconform -strict -summary -ignore-missing-schemas \
            -kubernetes-version "${{ matrix.kube_version }}" \
            "/tmp/tests_k8s_${{ matrix.kube_version }}.yaml"

      - name: Render contracts for Kubernetes ${{ matrix.kube_version }}
        run: |
          set -euo pipefail
          werf helm template contracts tests/contracts \
            --set global.env=production \
            --kube-version "${{ matrix.kube_version }}" > "/tmp/contracts_k8s_${{ matrix.kube_version }}.yaml"
          grep -q '^apiVersion:' "/tmp/contracts_k8s_${{ matrix.kube_version }}.yaml"

  kube-server-dry-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set lib version
        run: |
          LIB_VERSION=$(sed -n '/version/{s/version: //;p;}' charts/helm-apps/Chart.yaml)
          sed -i 's/_FLANT_APPS_LIBRARY_VERSION_/'${LIB_VERSION}'/' charts/helm-apps/templates/_apps-version.tpl

      - name: Install werf CLI
        uses: werf/actions/install@v2
        with:
          version: v2.57.1

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.0

      - name: Create kind cluster
        uses: helm/kind-action@v1.10.0
        with:
          node_image: kindest/node:v1.29.2

      - name: Install compatibility CRDs
        run: |
          set -euo pipefail
          kubectl apply -f tests/crds/compat-crds.yaml
          kubectl wait --for=condition=Established --timeout=120s crd --all

      - name: Update chart dependencies
        run: |
          werf helm dependency update tests/.helm
          werf helm dependency update tests/contracts

      - name: Render contracts for server-side validation
        run: |
          set -euo pipefail
          werf helm template contracts tests/contracts \
            --set "global.env=production" \
            --kube-version 1.29.0 \
            --set "apps-jobs.compat-job.restartPolicy=Never" \
            --set "apps-cronjobs.compat-cron.restartPolicy=Never" \
            --set "apps-kafka-strimzi.compat-kafka.enabled=false" \
            --set "apps-infra.node-groups.compat-group.enabled=false" \
            > /tmp/contracts_k8s_129_server.yaml

      - name: Server-side dry-run apply
        run: |
          set -euo pipefail
          kubectl apply --dry-run=server -f /tmp/contracts_k8s_129_server.yaml
