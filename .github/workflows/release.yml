name: Release Charts

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Set lib version
        run: |
          LIB_VERSION=$(sed -n '/version/{s/version: //;p;}' charts/helm-apps/Chart.yaml)
          echo "LIB_VERSION=${LIB_VERSION}" >> "$GITHUB_ENV"
          sed -i 's/_FLANT_APPS_LIBRARY_VERSION_/'${LIB_VERSION}'/' charts/helm-apps/templates/_apps-version.tpl

      - name: Install werf CLI
        uses: werf/actions/install@v1.2
        with:
          channel: ea

      - name: Install Dyff
        run: |
          curl --silent --location https://git.io/JYfAY | bash

      - name: Install kubeconform
        run: |
          set -euo pipefail
          KUBECONFORM_VERSION=0.6.7
          curl -sSL -o /tmp/kubeconform.tar.gz "https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz"
          tar -xzf /tmp/kubeconform.tar.gz -C /tmp kubeconform
          sudo install -m 0755 /tmp/kubeconform /usr/local/bin/kubeconform

      - name: Update test chart dependencies
        run: |
          werf helm dependency update tests/.helm

      - name: Validate values schema
        run: |
          werf helm lint tests/.helm --values tests/.helm/values.yaml

      - name: Verify Kubernetes API compatibility
        run: |
          set -euo pipefail

          # New clusters: stable APIs must be rendered.
          werf helm template tests tests/.helm \
            --set "global.env=prod" \
            --set "global._includes.apps-defaults.enabled=true" \
            --kube-version 1.29.0 > /tmp/tests_k8s_129.yaml
          grep -q '^apiVersion: policy/v1$' /tmp/tests_k8s_129.yaml
          grep -q '^apiVersion: batch/v1$' /tmp/tests_k8s_129.yaml
          grep -q '^apiVersion: autoscaling/v2$' /tmp/tests_k8s_129.yaml
          ! grep -q '^apiVersion: policy/v1beta1$' /tmp/tests_k8s_129.yaml
          ! grep -q '^apiVersion: batch/v1beta1$' /tmp/tests_k8s_129.yaml
          ! grep -q '^apiVersion: autoscaling/v2beta2$' /tmp/tests_k8s_129.yaml
          kubeconform -strict -summary -ignore-missing-schemas -kubernetes-version 1.29.0 /tmp/tests_k8s_129.yaml

          # Legacy clusters: beta APIs remain supported.
          werf helm template tests tests/.helm \
            --set "global.env=prod" \
            --set "global._includes.apps-defaults.enabled=true" \
            --kube-version 1.20.15 > /tmp/tests_k8s_120.yaml
          grep -q '^apiVersion: policy/v1beta1$' /tmp/tests_k8s_120.yaml
          grep -q '^apiVersion: batch/v1beta1$' /tmp/tests_k8s_120.yaml
          grep -q '^apiVersion: autoscaling/v2beta2$' /tmp/tests_k8s_120.yaml
          ! grep -q '^apiVersion: autoscaling/v2$' /tmp/tests_k8s_120.yaml
          kubeconform -strict -summary -ignore-missing-schemas -kubernetes-version 1.20.15 /tmp/tests_k8s_120.yaml

      - name: Render
        run: |
          set -e
          source $(werf ci-env github --as-file)
          cd tests && werf render --dev --set "global._includes.apps-defaults.enabled=true" --env=prod

      - name: Test render
        run: |
          set -e
          source $(werf ci-env github --as-file)
          cd tests && werf render --dev --set "global._includes.apps-defaults.enabled=true" --env=prod | sed '/werf.io\//d' > test_render_check.yaml
          dyff between test_render.yaml test_render_check.yaml | tee /tmp/test_render_check
          check_tests=$(sed 1,7d /tmp/test_render_check | wc -l)
          if [ $check_tests -gt "7" ]; then exit 1; fi

      - name: Check apps entity coverage in contracts
        run: |
          set -euo pipefail
          bash scripts/check-entity-coverage.sh

      - name: Contract checks (snapshot + structural + negative)
        run: |
          set -euo pipefail
          bash scripts/check-contracts.sh

      - name: Run chart-releaser
        if: ${{ github.ref == 'refs/heads/main' }}
        uses: helm/chart-releaser-action@v1.4.0
        with:
          charts_dir: charts
          config: cr.yaml
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Generate and update GitHub release notes
        if: ${{ github.ref == 'refs/heads/main' }}
        env:
          GH_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        run: |
          set -euo pipefail

          TAG="helm-apps-${LIB_VERSION}"

          if ! gh release view "${TAG}" >/dev/null 2>&1; then
            echo "Release ${TAG} not found (nothing new to publish), skipping notes update."
            exit 0
          fi

          CHANGELOG_BODY="$(awk -v ver="${LIB_VERSION}" '
            $0 ~ "^## \\[" ver "\\]" {capture=1; next}
            capture && $0 ~ "^## \\[" {exit}
            capture {print}
          ' CHANGELOG.md)"

          if [ -n "${CHANGELOG_BODY}" ]; then
            GENERATED_BODY="${CHANGELOG_BODY}"
          else
            GENERATED_BODY=$(gh api -X POST "repos/${GITHUB_REPOSITORY}/releases/generate-notes" \
              -f tag_name="${TAG}" \
              -f target_commitish="${GITHUB_SHA}" \
              --jq '.body')
          fi

          {
            echo "## Helm Apps Library"
            echo
            echo "- Chart: \`helm-apps\`"
            echo "- Version: \`${LIB_VERSION}\`"
            echo
            echo "${GENERATED_BODY}"
          } > /tmp/release_notes.md

          gh release edit "${TAG}" \
            --title "helm-apps ${LIB_VERSION}" \
            --notes-file /tmp/release_notes.md

#    - name: Publish to CR
#      env:
#        CR_PAT: ${{ secrets.CR_PAT }}
#      run: |
#        echo $CR_PAT | helm registry login -u alvnukov  --password-stdin ghcr.io
#        find .cr-release-packages -mindepth 1 -maxdepth 1 -type f -name '*.tgz' -exec sh -c 'basename "$0"' '{}' \; | while read PACKAGE; do
#        helm push .cr-release-packages/$PACKAGE oci://ghcr.io/${GITHUB_REPOSITORY}
#        done
